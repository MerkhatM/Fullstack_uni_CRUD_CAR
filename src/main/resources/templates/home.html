<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" rel="stylesheet">
    <script crossorigin="anonymous"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body onload="loadCars()">
<div class="container mb-4" th:insert="~{navbar}"></div>
<div class="container col-8 mx-auto">
    <input id="id" type="hidden">
    <input class="form-control" id="mark" placeholder="Insert mark" type="text"><br>
    <input class="form-control" id="model" placeholder="Insert model" type="text"><br>
    <input class="form-control" id="year" min="1920" placeholder="Insert year" type="number"><br>
    <input class="form-control" id="color" placeholder="Insert color" type="text"><br>
    <label>РАСТАМОЖЕН В КАЗАХСТАНЕ</label>
    <input id="registrationKz1" name="registrationKz" type="radio" value="true"/>
    <label for="registrationKz1">YES</label>
    <input id="registrationKz2" name="registrationKz" type="radio" value="false"/>
    <label for="registrationKz2">NO</label><br><br>
    <button class="btn btn-success" id='addBtn' onclick="addCar()">ADD CAR</button>
    <button class="btn btn-primary" id='editBtn' onclick="editCar()" style="display: none">EDIT CAR</button>
    <br>

    <table class="table table-striped" id="academyTable">
        <thead>
        <th>ID</th>
        <th>MARK</th>
        <th>MODEL</th>
        <th>YEAR</th>
        <th>COLOR</th>
        <th>REGISTERED IN KZ</th>
        <th>DETAILS</th>
        <th>DELETE</th>
        </thead>
        <tbody id="allCars">
        </tbody>
    </table>
</div>

<script type="text/javascript">
    function loadCars() {
        let dataCar = "";
        let httpRequest = new XMLHttpRequest;
        httpRequest.open("GET", "http://localhost:8090/cars", true);
        httpRequest.send()
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                let cars = JSON.parse(httpRequest.responseText);
                for (let i = 0; i < cars.length; i++) {
                    dataCar += "<tr>"
                    dataCar += "<td>" + cars[i].id + "</td>"
                    dataCar += "<td>" + cars[i].mark + "</td>"
                    dataCar += "<td>" + cars[i].model + "</td>"
                    dataCar += "<td>" + cars[i].year + "</td>"
                    dataCar += "<td>" + cars[i].color + "</td>"
                    dataCar += "<td>" + cars[i].registrationKz + "</td>"
                    dataCar += "<td><button class='btn btn-info' onclick='detailsCar(" + cars[i].id + ")'>DETAILS</button>"
                    dataCar += "<td><button class='btn btn-danger' onclick='deleteCar(" + cars[i].id + ")'>DELETE</button>"
                    dataCar += "</tr>"
                }

                document.getElementById('allCars').innerHTML = dataCar;
            }
        }
    }

    document.getElementById('registeredInKz').addEventListener('click', loadCarsRegisteredKz);

    function loadCarsRegisteredKz() {
        let dataCar = "";
        let httpRequest = new XMLHttpRequest;
        httpRequest.open("GET", "http://localhost:8090/cars/registeredInKz", true);
        httpRequest.send()
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                let cars = JSON.parse(httpRequest.responseText);
                for (let i = 0; i < cars.length; i++) {
                    dataCar += "<tr>"
                    dataCar += "<td>" + cars[i].id + "</td>"
                    dataCar += "<td>" + cars[i].mark + "</td>"
                    dataCar += "<td>" + cars[i].model + "</td>"
                    dataCar += "<td>" + cars[i].year + "</td>"
                    dataCar += "<td>" + cars[i].color + "</td>"
                    dataCar += "<td>" + cars[i].registrationKz + "</td>"
                    dataCar += "<td><button class='btn btn-info' onclick='detailsCar(" + cars[i].id + ")'>DETAILS</button>"
                    dataCar += "<td><button class='btn btn-danger' onclick='deleteCar(" + cars[i].id + ")'>DELETE</button>"
                    dataCar += "</tr>"
                }

                document.getElementById('allCars').innerHTML = dataCar;
            }
        }
    }

    document.getElementById('unRegisteredInKz').addEventListener('click', loadCarsUnRegisteredKz);

    function loadCarsUnRegisteredKz() {
        let dataCar = "";
        let httpRequest = new XMLHttpRequest;
        httpRequest.open("GET", "http://localhost:8090/cars/unRegisteredInKz", true);
        httpRequest.send()
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                let cars = JSON.parse(httpRequest.responseText);
                for (let i = 0; i < cars.length; i++) {
                    dataCar += "<tr>"
                    dataCar += "<td>" + cars[i].id + "</td>"
                    dataCar += "<td>" + cars[i].mark + "</td>"
                    dataCar += "<td>" + cars[i].model + "</td>"
                    dataCar += "<td>" + cars[i].year + "</td>"
                    dataCar += "<td>" + cars[i].color + "</td>"
                    dataCar += "<td>" + cars[i].registrationKz + "</td>"
                    dataCar += "<td><button class='btn btn-info' onclick='detailsCar(" + cars[i].id + ")'>DETAILS</button>"
                    dataCar += "<td><button class='btn btn-danger' onclick='deleteCar(" + cars[i].id + ")'>DELETE</button>"
                    dataCar += "</tr>"
                }

                document.getElementById('allCars').innerHTML = dataCar;
            }
        }
    }

    document.getElementById("searchBtn").addEventListener('click', searchCars)

    function searchCars() {
        let dataCar = "";
        let startYear = document.getElementById("startYear").value
        let endYear = document.getElementById("endYear").value
        let searchInp = document.getElementById("search").value
        let httpRequest = new XMLHttpRequest;
        httpRequest.open("GET", "http://localhost:8090/cars/search?search=" + searchInp + "&startYear=" + startYear + "&endYear=" + endYear, true);
        httpRequest.send()
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                let cars = JSON.parse(httpRequest.responseText);
                for (let i = 0; i < cars.length; i++) {
                    dataCar += "<tr>"
                    dataCar += "<td>" + cars[i].id + "</td>"
                    dataCar += "<td>" + cars[i].mark + "</td>"
                    dataCar += "<td>" + cars[i].model + "</td>"
                    dataCar += "<td>" + cars[i].year + "</td>"
                    dataCar += "<td>" + cars[i].color + "</td>"
                    dataCar += "<td>" + cars[i].registrationKz + "</td>"
                    dataCar += "<td><button class='btn btn-info' onclick='detailsCar(" + cars[i].id + ")'>DETAILS</button>"
                    dataCar += "<td><button class='btn btn-danger' onclick='deleteCar(" + cars[i].id + ")'>DELETE</button>"
                    dataCar += "</tr>"
                }

                document.getElementById('allCars').innerHTML = dataCar;
            }
        }
    }


    document.getElementById('filterByRangeYear').addEventListener('click', searchCars);


    function addCar() {
        let mark = document.getElementById('mark').value
        let model = document.getElementById('model').value
        let year = document.getElementById('year').value
        let color = document.getElementById('color').value
        let registrationKz = document.getElementsByName('registrationKz');
        let checked = ""
        for (let i = 0; i < registrationKz.length; i++) {
            if (registrationKz[i].checked) {
                checked = registrationKz[i].value
            }
        }


        let car = {
            "mark": mark,
            "model": model,
            "year": year,
            "color": color,
            "registrationKz": checked
        }
        let httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", "http://localhost:8090/cars", true)
        httpRequest.setRequestHeader("Content-Type", "application/json")
        httpRequest.send(JSON.stringify(car))
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                loadCars();
                alert("CAR ADDED SUCCESFULLY!")
            }
        }
    }

    function detailsCar(id) {
        let httpRequest = new XMLHttpRequest()
        httpRequest.open("GET", "http://localhost:8090/cars/" + id)
        httpRequest.send()
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                let car = JSON.parse(httpRequest.responseText)
                document.getElementById('id').value = car.id
                document.getElementById('mark').value = car.mark
                document.getElementById('model').value = car.model
                document.getElementById('year').value = car.year
                document.getElementById('color').value = car.color
                document.getElementById('editBtn').style = 'display:inline'
                if (car.registrationKz === true) {
                    document.getElementById('registrationKz1').checked = true;
                } else if (car.registrationKz === false) {
                    document.getElementById('registrationKz2').checked = true;
                }
            }
        }
    }


    function editCar() {
        let registrationKz = document.getElementsByName('registrationKz');
        let checked = ""
        for (let i = 0; i < registrationKz.length; i++) {
            if (registrationKz[i].checked) {
                checked = registrationKz[i].value
            }
        }
        let car = {
            "id": document.getElementById('id').value,
            "mark": document.getElementById('mark').value,
            "model": document.getElementById('model').value,
            "year": document.getElementById('year').value,
            "color": document.getElementById('color').value,
            "registrationKz": checked

        }

        let httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", "http://localhost:8090/cars", true)
        httpRequest.setRequestHeader("Content-Type", "application/json")
        httpRequest.send(JSON.stringify(car))
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                document.getElementById('id').value = ""
                document.getElementById('mark').value = ""
                document.getElementById('model').value = ""
                document.getElementById('year').value = ""
                document.getElementById('color').value = ""
                document.getElementById('registrationKz1').checked = false
                document.getElementById('registrationKz2').checked = false
                document.getElementById('addBtn').style = 'display:inline'
                document.getElementById('editBtn').style = 'display:none'
                loadCars()
            }
        }

    }

    function deleteCar(id) {
        let httpRequest = new XMLHttpRequest();
        httpRequest.open("DELETE", "http://localhost:8090/cars/" + id)
        httpRequest.send()
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                loadCars()
            }
        }
    }


</script>
</body>
</html>